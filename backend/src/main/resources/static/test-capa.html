<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Teste capa do álbum (MinIO)</title>
  <style>
    body{font-family:system-ui,Arial;margin:20px;max-width:900px}
    input,button{padding:8px;margin:4px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .box{border:1px solid #ddd;border-radius:8px;padding:12px;margin-top:12px}
    code{background:#f6f6f6;padding:2px 4px;border-radius:4px}
    img{max-width:420px;display:block;margin-top:8px;border:1px solid #eee}
    .ok{color:green}
    .err{color:#b00020}
    pre{background:#0b1020;color:#e6e6e6;padding:12px;border-radius:8px;overflow:auto}
  </style>
</head>
<body>
<h2>Teste de capa do álbum</h2>
<p>Abra este HTML por <code>http://localhost:8080/test-capa.html</code> (mesma origem do backend).</p>

<div class="box">
  <h3>1) Login</h3>
  <div class="row">
    <div>
      <div>Email</div>
      <input id="email" value="teste@teste.com" size="28"/>
    </div>
    <div>
      <div>Senha</div>
      <input id="senha" value="Senha@123" size="18"/>
    </div>
  </div>
  <button id="btnLogin">Login</button>
  <div id="loginStatus"></div>
</div>

<div class="box">
  <h3>2) Criar álbum</h3>
  <div class="row">
    <div>
      <div>Título</div>
      <input id="titulo" value="Album Teste" size="28"/>
    </div>
    <div>
      <div>Ano</div>
      <input id="ano" value="2026" size="6"/>
    </div>
  </div>
  <button id="btnCriar">Criar</button>
  <div>Album ID: <code id="albumId">---</code></div>
</div>

<div class="box">
  <h3>3) Enviar capa</h3>
  <input id="file" type="file" accept="image/*"/>
  <button id="btnEnviar">Enviar capa</button>
  <div id="capaStatus"></div>

  <div style="margin-top:8px">
    URL retornada: <a id="url" href="#" target="_blank" rel="noopener">---</a>
    <div style="margin-top:6px">
      <button id="btnFixHost" type="button">Se vier host "minio", trocar para "localhost"</button>
    </div>
    <img id="img" alt="prévia capa"/>
  </div>
</div>

<h3>Log</h3>
<pre id="log"></pre>

<script>
  let token = null;

  const log = (x) => {
    const el = document.getElementById("log");
    el.textContent = (typeof x === "string" ? x : JSON.stringify(x, null, 2)) + "\n" + el.textContent;
  };

  const api = (path) => `${location.origin}${path}`;

  async function postJson(path, bodyObj, auth=true) {
    const headers = {"Content-Type":"application/json"};
    if (auth && token) headers["Authorization"] = `Bearer ${token}`;
    const r = await fetch(api(path), {method:"POST", headers, body: JSON.stringify(bodyObj)});
    const txt = await r.text();
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch { data = txt; }
    return {ok:r.ok, status:r.status, data};
  }

  document.getElementById("btnLogin").onclick = async () => {
    const email = document.getElementById("email").value.trim();
    const senha = document.getElementById("senha").value;
    const res = await postJson("/api/v1/autenticacao/login", {email, senha}, false);

    if (!res.ok) {
      document.getElementById("loginStatus").innerHTML = `<span class="err">Falhou (${res.status})</span>`;
      log(res);
      return;
    }
    token = res.data.accessToken;
    document.getElementById("loginStatus").innerHTML = `<span class="ok">OK</span>`;
    log({login:"ok", tokenPreview: token.slice(0, 20) + "..."});
  };

  document.getElementById("btnCriar").onclick = async () => {
    const titulo = document.getElementById("titulo").value.trim();
    const anoLancamento = Number(document.getElementById("ano").value);
    const res = await postJson("/api/v1/albuns", {titulo, anoLancamento}, true);

    if (!res.ok) { log(res); alert("Falhou criar álbum"); return; }
    document.getElementById("albumId").textContent = res.data.id;
    log({albumCriado: res.data});
  };

  document.getElementById("btnEnviar").onclick = async () => {
    const albumId = document.getElementById("albumId").textContent.trim();
    const file = document.getElementById("file").files[0];
    if (!albumId || albumId === "---") return alert("Crie um álbum antes.");
    if (!file) return alert("Selecione uma imagem.");

    const fd = new FormData();
    fd.append("arquivo", file);

    const r = await fetch(api(`/api/v1/albuns/${albumId}/capa`), {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` },
      body: fd
    });

    const data = await r.json().catch(() => null);
    log({status:r.status, data});

    if (!r.ok) {
      document.getElementById("capaStatus").innerHTML = `<span class="err">Falhou (${r.status})</span>`;
      return;
    }

    document.getElementById("capaStatus").innerHTML = `<span class="ok">OK</span>`;
    document.getElementById("url").textContent = data.url;
    document.getElementById("url").href = data.url;
    document.getElementById("img").src = data.url;
  };

  document.getElementById("btnFixHost").onclick = () => {
    const a = document.getElementById("url");
    if (!a.href || a.href === "about:blank") return;
    const fixed = a.href.replace("http://minio:9000", "http://localhost:9000");
    a.href = fixed; a.textContent = fixed;
    document.getElementById("img").src = fixed;
    log({fixedUrl: fixed});
  };
</script>
</body>
</html>
